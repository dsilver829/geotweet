function newItem() {
  var currentId = $('.list-group-item').first().attr('id');
  var newId = "<%= @geotweets.results.to_a.first ? @geotweets.results.to_a.first.id : 0 %>";
  return currentId != newId;
}

var total = <%= @geotweets.results.total %>;
while(total > 0 && $('#geotweet-list').children().length >= <%= Geotweet::LIMIT %> && newItem()) {
  var item = $('.list-group-item').last();
  window.markers[item.attr('id')].setMap(null);
  delete window.markers[item.attr('id')];
  item.remove();
}

<% @geotweets.results.to_a.reverse.each do |geotweet| %>
  if ($("#<%= geotweet.id %>").length == 0 && $('#geotweet-list').children().length < 250) {
    $('ol#geotweet-list').prepend("<%= escape_javascript render partial: 'list_item', locals: { 'geotweet': geotweet } %>");

    var latitude = parseFloat(<%= geotweet.latitude %>);
    var longitude = parseFloat(<%= geotweet.longitude %>);
    var latLng = new google.maps.LatLng({lat: latitude, lng: longitude});

    var marker = new google.maps.Marker({
      icon: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
      map: window.map,
      position: latLng,
      title: "<%= escape_javascript geotweet.status %>"
    });
    window.markers["<%= geotweet.id %>"] = marker;

    marker.addListener('mouseover', function() {
      $('li#<%= geotweet.id %>').addClass('active');
    });

    marker.addListener('mouseout', function() {
      $('li#<%= geotweet.id %>').removeClass('active');
    });

    $('li#<%= geotweet.id %>').mouseover(function () {
      $(this).addClass('active');
      var marker = window.markers["<%= geotweet.id %>"];
      marker.setIcon('http://maps.google.com/mapfiles/ms/icons/green-dot.png');
      marker.setZIndex(google.maps.Marker.MAX_ZINDEX + 1);
    });

    $('li#<%= geotweet.id %>').mouseout(function () {
      $(this).removeClass('active');
      var marker = window.markers["<%= geotweet.id %>"];
      marker.setIcon('http://maps.google.com/mapfiles/ms/icons/red-dot.png');
      marker.setZIndex(0);
    });
  }
<% end %>
