function newItem() {
  var currentId = $('.list-group-item').first().attr('id');
  var newId = "<%= @geotweets.results.to_a.first ? @geotweets.results.to_a.first.id : 0 %>";
  return currentId != newId;
}

$.fn.inView = function(inViewType){
  var viewport = {};
  viewport.top = $(window).scrollTop();
  viewport.bottom = viewport.top + $(window).height();
  var bounds = {};
  bounds.top = this.offset().top;
  bounds.bottom = bounds.top + this.outerHeight();
  switch(inViewType){
    case 'bottomOnly':
      return ((bounds.bottom <= viewport.bottom) && (bounds.bottom >= viewport.top));
    case 'topOnly':
      return ((bounds.top <= viewport.bottom) && (bounds.top >= viewport.top));
    case 'both':
      return ((bounds.top >= viewport.top) && (bounds.bottom <= viewport.bottom));
    default:
      return ((bounds.top >= viewport.top) && (bounds.bottom <= viewport.bottom));
  }
};

var total = <%= @geotweets.results.total %>;
while(total > 0 && $('#geotweet-list').children().length >= <%= Geotweet::LIMIT %> && newItem()) {
  var item = $('.list-group-item').last();
  window.markers[item.attr('id')].setMap(null);
  delete window.markers[item.attr('id')];
  item.remove();
}

<% @geotweets.results.to_a.reverse.each do |geotweet| %>
  if ($("#<%= geotweet.id %>").length == 0 && $('#geotweet-list').children().length < 250) {
    $('ol#geotweet-list').prepend("<%= escape_javascript render partial: 'list_item', locals: { 'geotweet': geotweet } %>");

    var latitude = parseFloat(<%= geotweet.latitude %>);
    var longitude = parseFloat(<%= geotweet.longitude %>);
    var latLng = new google.maps.LatLng({lat: latitude, lng: longitude});

    var marker = new google.maps.Marker({
      icon: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
      map: window.map,
      position: latLng,
      title: "<%= escape_javascript geotweet.status %>"
    });
    window.markers["<%= geotweet.id %>"] = marker;

    marker.addListener('click', function() {
      $('html, body').animate({
        scrollTop: $('li#<%= geotweet.id %>').offset().top
      }, 500);
    });

    marker.addListener('mouseover', function() {
      var marker = window.markers["<%= geotweet.id %>"];
      $('li#<%= geotweet.id %>').addClass('active');
      marker.setIcon('http://maps.google.com/mapfiles/ms/icons/green-dot.png');
    });

    marker.addListener('mouseout', function() {
      var marker = window.markers["<%= geotweet.id %>"];
      $('li#<%= geotweet.id %>').removeClass('active');
      marker.setIcon('http://maps.google.com/mapfiles/ms/icons/red-dot.png');
    });

    $('li#<%= geotweet.id %>').mouseover(function () {
      $(this).addClass('active');
      var marker = window.markers["<%= geotweet.id %>"];
      marker.setIcon('http://maps.google.com/mapfiles/ms/icons/green-dot.png');
      marker.setZIndex(google.maps.Marker.MAX_ZINDEX + 1);
    });

    $('li#<%= geotweet.id %>').mouseout(function () {
      $(this).removeClass('active');
      var marker = window.markers["<%= geotweet.id %>"];
      marker.setIcon('http://maps.google.com/mapfiles/ms/icons/red-dot.png');
      marker.setZIndex(0);
    });
  }
<% end %>
